<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>–ö–∞—Ç–∞–ª–æ–≥ + AI</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #ffffff;
      min-height: 100vh;
      padding: 0;
      color: #1a1a1a;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* –ü—Ä–µ–ª–æ–∞–¥–µ—Ä */
    #preloader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #0190CC 0%, #0175a8 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }
    
    #preloader.hidden {
      opacity: 0;
      visibility: hidden;
    }
    
    .preloader-logo {
      width: 180px;
      height: auto;
      animation: logoFadeIn 1s ease, logoPulse 2s ease infinite;
      filter: drop-shadow(0 4px 20px rgba(255, 255, 255, 0.3));
    }
    
    .preloader-spinner {
      margin-top: 30px;
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    .preloader-text {
      margin-top: 20px;
      color: #fff;
      font-size: 16px;
      font-weight: 500;
      animation: textFadeIn 1.5s ease;
      text-align: center;
      max-width: 400px;
      line-height: 1.5;
    }
    
    h1 {
      font-size: 28px;
      font-weight: 700;
      color: #0190CC;
      margin: 0 0 24px 0;
      text-align: left;
      letter-spacing: -0.3px;
      animation: fadeInDown 0.6s ease;
      padding: 20px 20px 0 20px;
    }
    
    h2 {
      font-size: 18px;
      font-weight: 600;
      color: #0190CC;
      margin: 0 0 20px 0;
      display: flex;
      align-items: center;
    }
    
    h2::before {
      display: none;
    }
    
    .card {
      background: transparent;
      padding: 0 20px;
      margin-bottom: 0;
      transition: all 0.3s ease;
      animation: fadeInUp 0.5s ease;
    }
    
    .card:last-child {
      margin-bottom: 0;
      padding-bottom: 40px;
    }
    
    label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    input[type="text"] {
      width: 100%;
      padding: 14px 16px;
      font-size: 16px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background: #fff;
      color: #1a1a1a;
      font-family: inherit;
      transition: all 0.2s ease;
      cursor: text;
    }
    
    input[type="text"]:focus {
      outline: none;
      border-color: #0190CC;
      box-shadow: 0 0 0 3px rgba(1, 144, 204, 0.1);
    }
    
    input[type="text"]::placeholder {
      color: #9ca3af;
    }
    
    select {
      width: 100%;
      padding: 14px 16px;
      font-size: 16px;
      font-weight: 500;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background: #fff;
      color: #1a1a1a;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }
    
    select:hover {
      border-color: #0190CC;
    }
    
    select:focus {
      outline: none;
      border-color: #0190CC;
      box-shadow: 0 0 0 3px rgba(1, 144, 204, 0.1);
    }
    
    /* –ö–∞—Å—Ç–æ–º–Ω—ã–π –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ */
    .custom-select-wrapper {
      position: relative;
      width: 100%;
    }
    
    .custom-select {
      position: relative;
      width: 100%;
    }
    
    .select-selected {
      width: 100%;
      padding: 14px 16px;
      font-size: 16px;
      font-weight: 500;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background: #fff;
      color: #1a1a1a;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .select-selected::after {
      content: '';
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 6px solid #0190CC;
      margin-left: 10px;
      transition: transform 0.3s ease;
    }
    
    .select-selected.active::after {
      transform: rotate(180deg);
      border-top-color: #0190CC;
    }
    
    .select-selected:hover {
      border-color: #0190CC;
    }
    
    .select-items {
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid #0190CC;
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      z-index: 1000;
      max-height: 350px;
      overflow: hidden;
      animation: dropdownSlide 0.3s ease;
    }
    
    @keyframes dropdownSlide {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .search-in-dropdown {
      width: calc(100% - 24px) !important;
      margin: 12px 12px 8px 12px !important;
      padding: 10px 12px !important;
      border: 1px solid #e5e7eb !important;
      border-radius: 6px !important;
      font-size: 15px !important;
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 10;
    }
    
    .search-in-dropdown:focus {
      border-color: #0190CC !important;
      outline: none !important;
      box-shadow: 0 0 0 3px rgba(1, 144, 204, 0.1) !important;
    }
    
    #productList {
      max-height: 250px;
      overflow-y: auto;
      padding: 0 12px 12px 12px;
    }
    
    .product-item {
      padding: 12px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s ease;
      font-size: 15px;
      margin-bottom: 4px;
    }
    
    .product-item:hover {
      background: #e0f7ff;
      color: #0190CC;
      font-weight: 500;
    }
    
    .product-item:active {
      background: #0190CC;
      color: #fff;
    }
    
    textarea {
      width: 100%;
      padding: 14px 16px;
      font-size: 15px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      margin-top: 12px;
      font-family: inherit;
      resize: vertical;
      min-height: 100px;
      transition: all 0.2s ease;
    }
    
    textarea:focus {
      outline: none;
      border-color: #0190CC;
      box-shadow: 0 0 0 3px rgba(1, 144, 204, 0.1);
    }
    
    textarea::placeholder {
      color: #9ca3af;
    }
    
    button {
      padding: 14px 28px;
      margin-top: 12px;
      border: none;
      border-radius: 8px;
      background: #F02137;
      color: #fff;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      font-family: inherit;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(240, 33, 55, 0.3);
      width: 100%;
    }
    
    button:hover {
      background: #d01828;
      box-shadow: 0 4px 12px rgba(240, 33, 55, 0.4);
    }
    
    button:active {
      transform: scale(0.98);
    }
    
    button:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    
    .answer {
      margin-top: 16px;
      background: #f8f9fa;
      padding: 16px;
      border-radius: 8px;
      border-left: 3px solid #0190CC;
      animation: slideIn 0.4s ease;
      white-space: pre-wrap;
      line-height: 1.7;
      color: #2d3748;
      font-size: 15px;
    }
    
    .error {
      margin-top: 16px;
      background: #fff5f5;
      padding: 16px;
      border-radius: 8px;
      border-left: 3px solid #F02137;
      color: #F02137;
      font-weight: 500;
      font-size: 14px;
      animation: shake 0.5s ease;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ–¥—É–∫—Ç–µ */
    .product-image {
      width: 100%;
      max-width: 100%;
      height: auto;
      margin: 0 0 32px 0;
      animation: fadeIn 0.5s ease;
      display: block;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    
    .price-btn {
      display: inline-flex;
      align-items: center;
      padding: 12px 20px;
      background: #0190CC;
      color: #fff;
      text-decoration: none;
      border-radius: 10px;
      font-weight: 600;
      font-size: 15px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(1, 144, 204, 0.3);
      margin-bottom: 24px;
    }
    
    .price-btn:hover {
      background: #0175a8;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(1, 144, 204, 0.4);
    }
    
    .price-btn::before {
      content: 'üí∞';
      margin-right: 8px;
      font-size: 18px;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–∞–∑–¥–µ–ª–æ–≤ */
    .info-section {
      margin-bottom: 40px;
      padding: 0;
      animation: fadeInUp 0.4s ease;
      background: transparent;
    }
    
    .info-section:last-child {
      margin-bottom: 0;
    }
    
    /* –í—Å–µ —Ä–∞–∑–¥–µ–ª—ã –≤ –µ–¥–∏–Ω–æ–º —Å—Ç–∏–ª–µ –±—Ä–µ–Ω–¥–∞ */
    .section-basic,
    .section-composition,
    .section-usage,
    .section-advantages,
    .section-special,
    .section-additional {
      background: transparent;
    }
    
    .section-title {
      font-size: 14px;
      font-weight: 700;
      color: #0190CC;
      margin: 0 0 16px 0;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      display: block;
      position: relative;
      padding-bottom: 8px;
    }
    
    .section-title::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 40px;
      height: 2px;
      background: #0190CC;
      border-radius: 2px;
    }
    
    .info-section:first-child .section-title {
      margin-top: 0;
    }
    
    #info .info-item {
      margin-bottom: 16px;
      animation: fadeIn 0.3s ease;
      padding: 16px;
      background: #fafafa;
      border-left: 3px solid #0190CC;
      border-radius: 6px;
      transition: all 0.2s ease;
    }
    
    #info .info-item:hover {
      background: #f5f5f5;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }
    
    #info .info-item:last-child {
      margin-bottom: 0;
    }
    
    #info .info-label {
      color: #0190CC;
      font-weight: 700;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
    }
    
    #info .info-label::before {
      content: '';
      width: 4px;
      height: 4px;
      background: #0190CC;
      border-radius: 50%;
      margin-right: 8px;
      display: block;
    }
    
    #info .info-value {
      font-size: 15px;
      color: #2d3748;
      line-height: 1.75;
      padding-left: 12px;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-weight: 400;
    }
    
    #info .info-value strong,
    #info .info-value b {
      color: #0190CC;
      font-weight: 700;
    }
    
    #info .info-value em,
    #info .info-value i {
      font-style: italic;
      color: #555;
    }
    
    #info .info-value ul,
    #info .info-value ol {
      margin: 4px 0;
      padding-left: 20px;
    }
    
    #info .info-value li {
      margin-bottom: 2px;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ */
    #history p {
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid #f0f0f0;
      animation: fadeIn 0.3s ease;
      white-space: pre-wrap;
      word-wrap: break-word;
      line-height: 1.7;
      font-size: 14px;
      color: #2d3748;
    }
    
    #history p:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    
    #history b {
      color: #0190CC;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: inline-block;
      margin-bottom: 6px;
    }
    
    #history strong {
      color: #0190CC;
      font-weight: 700;
    }
    
    #history em,
    #history i {
      font-style: italic;
      color: #555;
    }
    
    #history ul,
    #history ol {
      margin: 4px 0;
      padding-left: 20px;
    }
    
    #history li {
      margin-bottom: 2px;
    }
    
    .answer strong,
    .answer b {
      color: #0190CC;
      font-weight: 700;
    }
    
    .answer em,
    .answer i {
      font-style: italic;
      color: #555;
    }
    
    .answer ul,
    .answer ol {
      margin: 4px 0;
      padding-left: 20px;
    }
    
    .answer li {
      margin-bottom: 2px;
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes logoFadeIn {
      0% {
        opacity: 0;
        transform: scale(0.5);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    @keyframes logoPulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }
    
    @keyframes textFadeIn {
      0% {
        opacity: 0;
      }
      50% {
        opacity: 0;
      }
      100% {
        opacity: 1;
      }
    }
    
    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä */
    .container {
      max-width: 100%;
      margin: 0;
      opacity: 0;
      transition: opacity 0.5s ease;
      background: #ffffff;
    }
    
    .container.loaded {
      opacity: 1;
    }
    
    /* –°–µ—Ç–∫–∞ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ AI */
    .grid {
      display: block;
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
    @media (max-width: 768px) {
      body {
        padding: 0;
        font-size: 15px;
      }
      
      h1 {
        font-size: 24px;
        margin-bottom: 20px;
        padding: 16px 16px 0 16px;
      }
      
      h2 {
        font-size: 17px;
        margin-bottom: 16px;
      }
      
      .card {
        padding: 0 16px;
        margin-bottom: 0;
      }
      
      .card:last-child {
        padding-bottom: 32px;
      }
      
      .info-section {
        margin-bottom: 32px;
        padding: 0;
      }
      
      .section-title {
        font-size: 13px;
        margin-bottom: 14px;
        letter-spacing: 1px;
      }
      
      .section-title::after {
        width: 35px;
        height: 2px;
      }
      
      #info .info-item {
        margin-bottom: 14px;
        padding: 14px;
        border-left-width: 2px;
      }
      
      #info .info-label {
        font-size: 11px;
        margin-bottom: 8px;
        letter-spacing: 0.6px;
      }
      
      #info .info-label::before {
        width: 3px;
        height: 3px;
        margin-right: 6px;
      }
      
      #info .info-value {
        font-size: 14px;
        line-height: 1.7;
        padding-left: 9px;
      }
      
      .product-image {
        margin-bottom: 24px;
        border-radius: 0;
      }
      
      .container {
        max-width: 100%;
      }
      
      input[type="text"], select {
        padding: 16px;
        font-size: 16px;
      }
      
      textarea {
        padding: 16px;
        font-size: 16px;
        min-height: 120px;
      }
      
      button {
        padding: 16px;
        font-size: 16px;
      }
      
      label {
        font-size: 14px;
        margin-bottom: 10px;
      }
      
      .product-image {
        max-width: 100%;
      }
      
      .info-label {
        font-size: 13px;
      }
      
      .info-value {
        font-size: 16px;
      }
      
      .preloader-logo {
        width: 150px;
      }
    }
    
    /* –î–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
    @media (max-width: 375px) {
      h1 {
        font-size: 22px;
        padding: 12px 12px 0 12px;
      }
      
      .card {
        padding: 0 12px;
      }
      
      .info-section {
        margin-bottom: 28px;
      }
      
      .section-title {
        font-size: 12px;
        margin-bottom: 12px;
      }
      
      #info .info-item {
        margin-bottom: 12px;
        padding: 12px;
        border-left-width: 2px;
      }
      
      #info .info-label {
        font-size: 10px;
        margin-bottom: 6px;
      }
      
      #info .info-label::before {
        width: 3px;
        height: 3px;
        margin-right: 6px;
      }
      
      #info .info-value {
        font-size: 13px;
        line-height: 1.65;
        padding-left: 9px;
      }
    }
  </style>
</head>
<body>
  <!-- –ü—Ä–µ–ª–æ–∞–¥–µ—Ä -->
  <div id="preloader">
    <img src="https://vegapharm.tj/wp-content/uploads/2024/11/logo-1.svg" alt="VegaPharm Logo" class="preloader-logo">
    <div class="preloader-spinner"></div>
    <div class="preloader-text">–Ø –∏—â—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –í–∞—à–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–∞—Ö,<br>–ø–æ–¥–æ–∂–¥–∏—Ç–µ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥...</div>
  </div>

  <div class="container">
    <h1>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–¥—É–∫—Ç–µ</h1>
    
    <div class="card">
      <label>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç:</label>
      <div class="custom-select-wrapper">
        <div class="custom-select" id="customSelect">
          <div class="select-selected">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç...</div>
          <div class="select-items" id="selectItems" style="display: none;">
            <input type="text" id="searchProduct" placeholder="üîç –ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–∞..." class="search-in-dropdown">
            <div id="productList"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–¥—É–∫—Ç–µ</h2>
        <div id="info">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
      </div>

      <div class="card">
        <h2>–°–ø—Ä–æ—Å–∏—Ç—å —É –ò–ò</h2>
        <textarea id="question" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å..."></textarea>
        <button id="askBtn">–°–ø—Ä–æ—Å–∏—Ç—å</button>
        <div id="aiAnswer" class="answer" style="display:none;"></div>
        <div id="errorBox" class="error" style="display:none;"></div>
      </div>
    </div>

    <div class="card">
      <h2>–ò—Å—Ç–æ—Ä–∏—è</h2>
      <div id="history">–ü—É—Å—Ç–æ</div>
    </div>
  </div>

<script>
  const APP_URL = "https://script.google.com/macros/s/AKfycbzltqGBqztOH-40_geZxigJZMx44cEs-3LAZCdmx39KBd_IKyD4tkr15y1I2W2RLl-W/exec";

  async function apiGet(path){
    try{
      const res = await fetch(APP_URL+path);
      if(!res.ok) throw new Error("HTTP "+res.status);
      return await res.json();
    }catch(e){ return {ok:false,error:e.message}; }
  }

  // –í–ù–ò–ú–ê–ù–ò–ï: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ x-www-form-urlencoded, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ CORS preflight
  async function apiPostForm(data){
    try{
      const form = new URLSearchParams();
      Object.entries(data).forEach(([k,v])=> form.append(k, v));
      const res = await fetch(APP_URL, {
        method: "POST",
        body: form  // –±–µ–∑ headers: –±—Ä–∞—É–∑–µ—Ä —Å–∞–º –ø–æ—Å—Ç–∞–≤–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π Content-Type
      });
      if(!res.ok) throw new Error("HTTP "+res.status);
      return await res.json();
    }catch(e){ return {ok:false,error:e.message}; }
  }

  const customSelect=document.getElementById('customSelect');
  const selectSelected=document.querySelector('.select-selected');
  const selectItems=document.getElementById('selectItems');
  const searchInput=document.getElementById('searchProduct');
  const productList=document.getElementById('productList');
  const infoBox=document.getElementById('info');
  const aiAns=document.getElementById('aiAnswer');
  const errBox=document.getElementById('errorBox');
  const askBtn=document.getElementById('askBtn');
  const qEl=document.getElementById('question');
  const histBox=document.getElementById('history');
  
  let allProducts = []; // –•—Ä–∞–Ω–∏—Ç –≤—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã
  let currentProduct = ''; // –¢–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç

  function showError(msg){ errBox.style.display="block"; errBox.textContent=msg; }
  function clearError(){ errBox.style.display="none"; errBox.textContent=""; }

  async function loadProducts(){
    const js = await apiGet("?action=products");
    if(!js.ok){ showError(js.error); return; }
    allProducts = js.data || [];
    updateProductList(allProducts);
    if(allProducts.length){
      currentProduct = allProducts[0];
      selectSelected.textContent = allProducts[0];
      await onProductChange(); // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ –ø–µ—Ä–≤–æ–º –ø—Ä–æ–¥—É–∫—Ç–µ
    }
  }
  
  function updateProductList(products){
    productList.innerHTML = "";
    products.forEach(p=>{
      const div=document.createElement('div');
      div.className='product-item';
      div.textContent=p;
      div.addEventListener('click', function(){
        currentProduct = p;
        selectSelected.textContent = p;
        selectItems.style.display = 'none';
        selectSelected.classList.remove('active');
        searchInput.value = '';
        updateProductList(allProducts);
        onProductChange();
      });
      productList.appendChild(div);
    });
  }
  
  // –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
  selectSelected.addEventListener('click', function(e){
    e.stopPropagation();
    const isOpen = selectItems.style.display === 'block';
    if(isOpen){
      selectItems.style.display = 'none';
      selectSelected.classList.remove('active');
    } else {
      selectItems.style.display = 'block';
      selectSelected.classList.add('active');
      setTimeout(() => searchInput.focus(), 100);
    }
  });
  
  // –ü–æ–∏—Å–∫ –≤–Ω—É—Ç—Ä–∏ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
  searchInput.addEventListener('input', function(e){
    e.stopPropagation();
    const searchTerm = this.value.toLowerCase().trim();
    if(searchTerm === ''){
      updateProductList(allProducts);
    } else {
      const filtered = allProducts.filter(p => 
        p.toLowerCase().includes(searchTerm)
      );
      updateProductList(filtered);
    }
  });
  
  // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –ø–æ–∏—Å–∫
  searchInput.addEventListener('click', function(e){
    e.stopPropagation();
  });
  
  // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ —Å–ø–∏—Å–∫–∞
  document.addEventListener('click', function(e){
    if(!customSelect.contains(e.target)){
      selectItems.style.display = 'none';
      selectSelected.classList.remove('active');
      searchInput.value = '';
      updateProductList(allProducts);
    }
  });

  async function onProductChange(){
    clearError();
    if(!currentProduct) return;
    const name = currentProduct;
    const [info, hist] = await Promise.all([
      apiGet(`?action=product&name=${encodeURIComponent(name)}`),
      apiGet(`?action=history&name=${encodeURIComponent(name)}`)
    ]);

    if(info.ok){
      infoBox.innerHTML="";
      const obj=info.data||{};
      if(Object.keys(obj).length===0) infoBox.textContent="–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–¥—É–∫—Ç–µ";
      else {
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–ª—é—á–µ–π (–ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É –∏ —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–±–µ–ª–æ–≤)
        function normalizeKey(key) {
          return key.toLowerCase().trim();
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ –∫–ª—é—á—É (—Å —É—á–µ—Ç–æ–º —Ä–∞–∑–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –Ω–∞–ø–∏—Å–∞–Ω–∏—è)
        function getValue(keyVariants) {
          for(let key in obj) {
            const normalized = normalizeKey(key);
            if(keyVariants.some(v => normalizeKey(v) === normalized)) {
              return String(obj[key] || '').trim();
            }
          }
          return '';
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–æ—Ç–æ –≤ –Ω–∞—á–∞–ª–µ
        function displayPhotos() {
          const photos = [];
          Object.entries(obj).forEach(([k,v])=>{
            const value = String(v || '').trim();
            const keyLower = normalizeKey(k);
            // –ò—â–µ–º –≤—Å–µ –ø–æ–ª—è —Å–æ —Å—Å—ã–ª–∫–∞–º–∏ (—Ñ–æ—Ç–æ)
            if((value.startsWith('https://') || value.startsWith('http://'))) {
              photos.push({ key: k, url: value });
            }
          });
          
          if(photos.length > 0) {
            photos.forEach(photo => {
              const img = document.createElement('img');
              img.src = photo.url;
              img.alt = photo.key;
              img.className = 'product-image';
              img.onerror = function() { 
                this.style.display = 'none'; 
              };
              infoBox.appendChild(img);
            });
          }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∞
        function createSection(className, title, fields) {
          const section = document.createElement('div');
          section.className = `info-section ${className}`;
          
          const titleEl = document.createElement('div');
          titleEl.className = 'section-title';
          titleEl.textContent = title;
          section.appendChild(titleEl);
          
          let hasContent = false;
          fields.forEach(field => {
            const value = getValue(Array.isArray(field.key) ? field.key : [field.key]);
            if(value) {
              hasContent = true;
              const item = document.createElement('div');
              item.className = 'info-item';
              
              const label = document.createElement('div');
              label.className = 'info-label';
              label.textContent = field.label || field.key[0] || field.key;
              
              const valueDiv = document.createElement('div');
              valueDiv.className = 'info-value';
              valueDiv.innerHTML = value.replace(/\n/g, '<br>');
              
              item.appendChild(label);
              item.appendChild(valueDiv);
              section.appendChild(item);
            }
          });
          
          if(hasContent) {
            return section;
          }
          return null;
        }
        
        // –°–æ–∑–¥–∞–µ–º —Ä–∞–∑–¥–µ–ª—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
        
        // 1. –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ç–æ
        displayPhotos();
        
        // 2. –†–∞–∑–¥–µ–ª 1: –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        const section1 = createSection('section-basic', '–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', [
          { key: ['–¢–æ—Ä–≥–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ', '—Ç–æ—Ä–≥–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'], label: '–¢–æ—Ä–≥–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ' },
          { key: ['–ì—Ä—É–ø–ø–∞', '–≥—Ä—É–ø–ø–∞'], label: '–ì—Ä—É–ø–ø–∞' },
          { key: ['–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–µ –Ω–µ–ø–∞—Ç–µ–Ω—Ç–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ', '–ú–ù–ù', '–º–Ω–Ω'], label: '–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–µ –Ω–µ–ø–∞—Ç–µ–Ω—Ç–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ' }
        ]);
        if(section1) infoBox.appendChild(section1);
        
        // 3. –†–∞–∑–¥–µ–ª 2: –°–æ—Å—Ç–∞–≤ –∏ —Ñ–æ—Ä–º–∞
        const section2 = createSection('section-composition', '–°–æ—Å—Ç–∞–≤ –∏ —Ñ–æ—Ä–º–∞ –≤—ã–ø—É—Å–∫–∞', [
          { key: ['–°–æ—Å—Ç–∞–≤', '—Å–æ—Å—Ç–∞–≤'], label: '–°–æ—Å—Ç–∞–≤' },
          { key: ['–õ–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ –∏ —Ñ–æ—Ä–º–∞ –≤—ã–ø—É—Å–∫–∞', '–ª–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞', '—Ñ–æ—Ä–º–∞ –≤—ã–ø—É—Å–∫–∞'], label: '–õ–µ–∫–∞—Ä—Å—Ç–≤–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ –∏ —Ñ–æ—Ä–º–∞ –≤—ã–ø—É—Å–∫–∞' },
          { key: ['–£—Å–ª–æ–≤–∏—è –æ—Ç–ø—É—Å–∫–∞', '—É—Å–ª–æ–≤–∏—è –æ—Ç–ø—É—Å–∫–∞'], label: '–£—Å–ª–æ–≤–∏—è –æ—Ç–ø—É—Å–∫–∞' }
        ]);
        if(section2) infoBox.appendChild(section2);
        
        // 4. –†–∞–∑–¥–µ–ª 3: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
        const section3 = createSection('section-usage', '–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ', [
          { key: ['–§–∞—Ä–º–∞–∫–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–∞—è –≥—Ä—É–ø–ø–∞', '—Ñ–∞—Ä–º–∞–∫–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–∞—è –≥—Ä—É–ø–ø–∞'], label: '–§–∞—Ä–º–∞–∫–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–∞—è –≥—Ä—É–ø–ø–∞' },
          { key: ['–ü–æ–∫–∞–∑–∞–Ω–∏—è –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é', '–ø–æ–∫–∞–∑–∞–Ω–∏—è', '–ø–æ–∫–∞–∑–∞–Ω–∏—è –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é'], label: '–ü–æ–∫–∞–∑–∞–Ω–∏—è –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é' },
          { key: ['–°–ø–æ—Å–æ–± –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏ –¥–æ–∑—ã', '—Å–ø–æ—Å–æ–± –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è', '–¥–æ–∑—ã'], label: '–°–ø–æ—Å–æ–± –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏ –¥–æ–∑—ã' },
          { key: ['–ë–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å –∏ –ª–∞–∫—Ç–∞—Ü–∏—è', '–±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å', '–ª–∞–∫—Ç–∞—Ü–∏—è'], label: '–ë–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å –∏ –ª–∞–∫—Ç–∞—Ü–∏—è' }
        ]);
        if(section3) infoBox.appendChild(section3);
        
        // 5. –†–∞–∑–¥–µ–ª 4: –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
        const section4 = createSection('section-advantages', '–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞', [
          { key: ['–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞', '–ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞'], label: '–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞' }
        ]);
        if(section4) infoBox.appendChild(section4);
        
        // 6. –†–∞–∑–¥–µ–ª 5: –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
        const section5 = createSection('section-special', '–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞', [
          { key: ['–°–ü–í', '—Å–ø–≤'], label: '–°–ü–í' },
          { key: ['–ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ', '–ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ'], label: '–ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ' }
        ]);
        if(section5) infoBox.appendChild(section5);
        
        // 7. –†–∞–∑–¥–µ–ª 6: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ
        const section6 = createSection('section-additional', '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', [
          { key: ['–ê–Ω–∞–ª–æ–≥–∏', '–∞–Ω–∞–ª–æ–≥–∏'], label: '–ê–Ω–∞–ª–æ–≥–∏' },
          { key: ['–°—Ç–∞—Ç—É—Å –ø—Ä–æ–¥—É–∫—Ç–∞', '—Å—Ç–∞—Ç—É—Å', '—Å—Ç–∞—Ç—É—Å –ø—Ä–æ–¥—É–∫—Ç–∞'], label: '–°—Ç–∞—Ç—É—Å –ø—Ä–æ–¥—É–∫—Ç–∞' }
        ]);
        if(section6) infoBox.appendChild(section6);
      }
    } else showError(info.error||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏");

    if(hist.ok){
      histBox.innerHTML="";
      const items=hist.data||[];
      if(items.length===0) histBox.textContent="–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞";
      else items.forEach(h=>{
        const p = document.createElement('p');
        const questionText = String(h.question || '').replace(/\n/g, '<br>');
        const answerText = String(h.answer || '').replace(/\n/g, '<br>');
        p.innerHTML = `<b>–í–æ–ø—Ä–æ—Å:</b> ${questionText}<br><b>–û—Ç–≤–µ—Ç:</b> ${answerText}`;
        histBox.appendChild(p);
      });
    } else showError(hist.error||"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏");

    aiAns.style.display="none";
  }

  askBtn.addEventListener('click', async ()=>{
    clearError();
    const name = currentProduct;
    const question = qEl.value.trim();
    if(!name || !question){ showError("–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç –∏ –≤–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å"); return; }
    askBtn.disabled = true; askBtn.textContent = "–û–±—Ä–∞–±–æ—Ç–∫–∞...";
    const js = await apiPostForm({ action:"ask", name, question });
    askBtn.disabled = false; askBtn.textContent = "–°–ø—Ä–æ—Å–∏—Ç—å";
    if(!js.ok){ showError(js.error || "–û—à–∏–±–∫–∞ AI"); return; }
    aiAns.style.display = "block";
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º innerHTML –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ HTML-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    aiAns.innerHTML = String(js.answer || '').replace(/\n/g, '<br>');
    onProductChange(); // –æ–±–Ω–æ–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
  });
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –ø—Ä–µ–ª–æ–∞–¥–µ—Ä–∞ –∏ –ø–æ–∫–∞–∑–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
  function hidePreloader() {
    const preloader = document.getElementById('preloader');
    const container = document.querySelector('.container');
    
    if(preloader) {
      preloader.classList.add('hidden');
      // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–ª–æ–∞–¥–µ—Ä –∏–∑ DOM –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
      setTimeout(() => {
        preloader.remove();
      }, 500);
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–µ–π
    if(container) {
      setTimeout(() => {
        container.classList.add('loaded');
      }, 300);
    }
  }
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–ª–æ–∞–¥–µ—Ä
  async function initApp() {
    await loadProducts();
    // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–ª–æ–∞–¥–µ—Ä –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
    hidePreloader();
  }
  
  // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
  initApp();
</script>
</body>
</html>
